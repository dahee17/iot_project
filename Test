import RPi.GPIO as GPIO
import time
from RPLCD.i2c import CharLCD
from datetime import datetime
import json
import os

GPIO.setmode(GPIO.BCM)

# --- Pins ---
TRIG = 23
ECHO = 24
BUZZER = 12
SERVO = 18

GPIO.setup(TRIG, GPIO.OUT)
GPIO.setup(ECHO, GPIO.IN)
GPIO.setup(BUZZER, GPIO.OUT)
GPIO.setup(SERVO, GPIO.OUT)

# --- Servo PWM ---
pwm_servo = GPIO.PWM(SERVO, 50)
pwm_servo.start(0)

# --- LCD ---
lcd = CharLCD('PCF8574', 0x27)  # Check your I2C address

# --- JSON file ---
SCHEDULE_FILE = "schedule.json"

# --- Functions ---
def get_distance():
    GPIO.output(TRIG, True)
    time.sleep(0.00001)
    GPIO.output(TRIG, False)

    while GPIO.input(ECHO) == 0:
        pulse_start = time.time()
    while GPIO.input(ECHO) == 1:
        pulse_end = time.time()

    duration = pulse_end - pulse_start
    distance = duration * 17150
    return round(distance, 2)

def beep(duration=0.2):
    GPIO.output(BUZZER, True)
    time.sleep(duration)
    GPIO.output(BUZZER, False)

def lcd_print(line1, line2=""):
    lcd.clear()
    lcd.write_string(line1)
    lcd.cursor_pos = (1,0)
    lcd.write_string(line2)

def servo_move(angle):
    duty = 2.5 + (angle / 18)
    pwm_servo.ChangeDutyCycle(duty)
    time.sleep(0.5)
    pwm_servo.ChangeDutyCycle(0)

def load_schedule():
    if not os.path.exists(SCHEDULE_FILE):
        return None
    try:
        with open(SCHEDULE_FILE, "r") as f:
            return json.load(f)
    except:
        return None

# --- Main loop ---
try:
    while True:
        # Ultrasonic distance
        distance = get_distance()
        if distance <= 15:
            lcd_print("Object Detected!", f"Distance: {distance}cm")
            beep(0.2)
        else:
            lcd_print("Waiting...", f"Distance: {distance}cm")

        # Servo schedule
        schedule = load_schedule()
        now = datetime.now()
        if schedule:
            if now.hour == schedule.get("hour") and now.minute == schedule.get("minute"):
                end_time = time.time() + schedule.get("duration", 10)
                lcd_print("Servo Running!", f"Time left: {schedule.get('duration',10)}s")
                while time.time() < end_time:
                    servo_move(0)
                    servo_move(90)
                    servo_move(0)

        time.sleep(0.5)

except KeyboardInterrupt:
    pwm_servo.stop()
    GPIO.cleanup()
    lcd.clear()
